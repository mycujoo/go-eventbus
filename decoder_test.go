package eventbus

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestDecodingMessage(t *testing.T) {
	type simpleStruct struct {
		Text    string
		Content []byte
	}

	message := []uint8([]byte{0x2f, 0xff, 0x81, 0x3, 0x1, 0x1, 0xc, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x53, 0x74, 0x72, 0x75, 0x63, 0x74, 0x1, 0xff, 0x82, 0x0, 0x1, 0x2, 0x1, 0x4, 0x54, 0x65, 0x78, 0x74, 0x1, 0xc, 0x0, 0x1, 0x7, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x1, 0xa, 0x0, 0x0, 0x0, 0x11, 0xff, 0x82, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x0})
	target := &simpleStruct{}

	err := Decode(message, target)
	assert.Nil(t, err, "Failed to decode message")
	assert.Equal(t, "Hello", target.Text)
	assert.Equal(t, []byte("Hello"), target.Content)
}

func TestDecodingPartialStructMessage(t *testing.T) {
	type simpleStruct struct {
		Text string
	}

	message := []uint8([]byte{0x2f, 0xff, 0x81, 0x3, 0x1, 0x1, 0xc, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x53, 0x74, 0x72, 0x75, 0x63, 0x74, 0x1, 0xff, 0x82, 0x0, 0x1, 0x2, 0x1, 0x4, 0x54, 0x65, 0x78, 0x74, 0x1, 0xc, 0x0, 0x1, 0x7, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x1, 0xa, 0x0, 0x0, 0x0, 0x11, 0xff, 0x82, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x0})

	target := &simpleStruct{}

	err := Decode(message, target)
	assert.Nil(t, err, "Failed to decode message")
	assert.Equal(t, "Hello", target.Text)
}

func TestDecodingWrongStruct(t *testing.T) {
	type simpleStruct struct {
		Other string
	}

	message := []uint8([]byte{0x2f, 0xff, 0x81, 0x3, 0x1, 0x1, 0xc, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x53, 0x74, 0x72, 0x75, 0x63, 0x74, 0x1, 0xff, 0x82, 0x0, 0x1, 0x2, 0x1, 0x4, 0x54, 0x65, 0x78, 0x74, 0x1, 0xc, 0x0, 0x1, 0x7, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x1, 0xa, 0x0, 0x0, 0x0, 0x11, 0xff, 0x82, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x1, 0x5, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x0})

	target := &simpleStruct{}

	err := Decode(message, target)
	assert.NotNil(t, err, "Message decoded successfully")
	assert.Equal(t, err.Error(), "gob: type mismatch: no fields matched compiling decoder for simpleStruct")
}
